global
    daemon
    maxconn 4096

defaults
    mode http
    option httplog
    timeout connect 5s
    timeout client 30s
    timeout server 30s

frontend http_front
    bind *:8080

    acl api path_beg /api
    use_backend be_pool if api
    default_backend fe_pool

backend fe_pool
    balance roundrobin
    cookie FEID insert indirect nocache
    option httpchk GET /
    server fe1 fe1:3000 cookie f1 check
    server fe2 fe2:3000 cookie f2 check

backend be_pool
    balance leastconn
    cookie BEID insert indirect nocache
    option httpchk GET /api/health
    http-check expect status 200
    server be1 be1:5000 cookie s1 check
    server be2 be2:5000 cookie s2 check

listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
